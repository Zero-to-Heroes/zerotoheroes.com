<view-title>Upload</view-title>

<form name="uploadForm" class="upload-form main-panel background-white">

	<div class="form-container">
		<span class="btn btn-default btn-file" ng-hide="!useVideo">
			Choose your video <input type="file" name="file" class="upload-file-button" ng-required="useVideo" nv-file-select uploader="uploader" file analytics-on="click" analytics-category="upload" analytics-event="upload.chooseFile"></input>
		</span>
		<div class="alert alert-danger unsupported-file-alert" role="alert" ng-show="hasUnsupportedFormatError">
			<span>We're sorry, we only support .mp4, .ogg, .mkv and .webm video files, and don't support other media types for now. The main reason is that we can't provide our more advanced features if we have to rely on a Flash video player, which is mandatory for some file formats.</span>
		</div>

		<div class="videogular-container" ng-show="file && useVideo">
			<videogular vg-player-ready="onPlayerReady($API)" class="videogular" ng-class="{'videogular-fullscreen': API.isFullScreen, 'videogular-playing': !canvasState.drawingCanvas}"  vg-change-source="onSourceChanged($source)" vg-update-state="onStateUpdate($state)" class="videogular">
				<vg-media vg-src="sources"></vg-media>

				<vg-controls>
					<vg-play-pause-button></vg-play-pause-button>
					<vg-time-display>{{ currentTime | date:'mm:ss:sss' }}</vg-time-display>
					<vg-scrub-bar id="scrubBar" video-fine-time-control>
						<vg-scrub-bar-current-time help-popup help-popup-key="fineScrolling" help-popup-active="0" help-popup-position="top"></vg-scrub-bar-current-time>
					</vg-scrub-bar>
					<vg-time-display>{{ totalTime | date:'mm:ss' }}</vg-time-display>
					<video-canvas-overlay-button ng-show="playerControls.canvasId"></video-canvas-overlay-button>
				</vg-controls>

				<vg-overlay-play ng-click="onOverlayClick()" ng-show="!canvasState.drawingCanvas"></vg-overlay-play>

				<canvas id="fabricCanvas" pw-canvas></canvas>
			</videogular>
		</div>

		<div class="editing-tools" ng-show="file && useVideo">
			<div range-slider min="0" max="sliderMax" model-min="min" model-max="max" attach-handle-values="true" filter="timeFilter" getter-setter="true" ng-show="review.ending > 0" show-values="true" disabled="uploadInProgress"></div>
			<div class="buttons" ng-show="dataLoaded">
				<span class="durationText">Clip duration: {{clipDuration | date:'mm:ss' }}</span>
				<span class="block"><a ng-click="review.videoFramerateRatio = 2; maximumAllowedDuration = maximumAllowedDuration * review.videoFramerateRatio">Double the speed</a> of the video</span>
				<span class="block" ng-show="review.videoFramerateRatio && review.videoFramerateRatio != 1">The final video will be {{videoFramerateRatio}} times as fast (and as short) as the original, and won't have any audio. Click <a ng-click="maximumAllowedDuration = maximumAllowedDuration / review.videoFramerateRatio; review.videoFramerateRatio = 1">here</a> to go back to the original speed</span>
			</div>
			<div class="alert alert-danger" role="alert" ng-show="(clipDuration / 1000) > maximumAllowedDuration">
				<span>To keep the reviews focused, we are enforcing a 5 minutes time limit on videos. You can either:</span>
				<ul>
					<li>Use the slider above the select up to 5 minutes of video to use</li>
					<li><a ng-click="review.videoFramerateRatio = 2; maximumAllowedDuration = maximumAllowedDuration * review.videoFramerateRatio">Double the speed</a> of the video to use up to 10 minutes of video. This is for now experimental and will only work if your video has less than 30 images per seconds (which is the case for most camera and phone videos, and the default for many video recording softwares)</li>
				</ul>
			</div>
			<hr>
		</div>
		<div class="video-information panel-no-border">
			<h1>{{useVideo ? 'Video information' : 'New post'}}</h1>

			<div class="container-fluid">
				<div class="row" ng-hide="User.isLoggedIn()">
					<div class="col-sm-12">
						<div class="form-group" show-errors="{ showSuccess: true }">
							<div class="alert alert-danger" role="alert" ng-show="uploadForm.author.$error.nameTaken"><span>This name is already in use, please pick another one, or <a ng-click="signIn()">sign in</a> if that's you</span></div>
							<input type="text" name="author" class="form-control" ng-model="review.author" placeholder="Your name" ng-required="!User.isLoggedIn()" ng-readonly="uploadInProgress">
						</div>
				  	</div>
			  	</div>
		  		<div class="row">
					<div ng-class="{'col-sm-4': useVideo}" ng-show="useVideo">
			  			<div class="form-group" show-errors="{ showSuccess: true }">
						    <select ng-model="review.sport" name="sport" class="form-control" ng-required="true" ng-readonly="!useVideo" ng-readonly="uploadInProgress">
								<option value="" ng-hide="!useVideo">Choose your sport...</option>
								<option value="Squash" ng-hide="!useVideo">Squash</option>
								<option value="Badminton" ng-hide="!useVideo">Badminton</option>
								<option value="LeagueOfLegends" ng-hide="!useVideo">League of Legends</option>
								<option value="HeroesOfTheStorm" ng-hide="!useVideo">Heroes of the Storm</option>
								<option value="HearthStone" ng-hide="!useVideo">HearthStone</option>
								<option value="Meta" ng-show="!useVideo">Meta</option>
								<option value="Other" ng-hide="!useVideo">Other</option>
							</select>
						</div>
					</div>
					<div ng-class="{'col-sm-8': useVideo, 'col-sm-12': !useVideo}">
			  			<div class="form-group" show-errors="{ showSuccess: true }">
					    	<input type="text" name="title" class="form-control" ng-model="review.title" placeholder="Title {{useVideo ? 'of your video review' : ''}}" ng-required="true" ng-readonly="uploadInProgress">
					  	</div>
				  	</div>
			  	</div>
		  		<div class="row">
					<div class="col-sm-12">
					  	<div class="form-group">
							<toolbar player-api="API" insert-model="insertModel" ng-show="useVideo" drawing-canvas="canvasState.drawingCanvas" canvas-id="canvasState.canvasId">
					    		<textarea class="form-control" rows="3" placeholder="Any remarks about what you want to improve" ng-model="review.text" ng-readonly="uploadInProgress" auto-grow toolbar-target ng-required="true"></textarea>
					    	</toolbar>
					    	<textarea class="form-control" rows="3" placeholder="Any remarks {{useVideo ? 'about what you want to improve' : 'or comments'}}" ng-model="review.text" ng-readonly="uploadInProgress" auto-grow ng-hide="useVideo"></textarea>
					   </div>
					</div>
					<div class="inline-block float-right show-help-buttons">
					  	<a class="link-minor" ng-click="showHelp = true" ng-show="!showHelp">Show formatting help</a>
						<a class="link-minor" ng-click="showHelp = false" ng-show="showHelp">Hide formatting help</a>
					</div>
			  	</div>
				<div ng-show="showHelp" ng-include="'/templates/formattingHelp.html'"></div>
				<div class="alert alert-info" role="alert" ng-show="hasTimestamps && review.beginning > 0">
					<span>It looks like you are using timestamps and have changed the beginning time of your video. Don't worry that the timestamps text still reflects the original time of the video. We're making sure everything will be fine in the end :)</span>
				</div>
				<div class="row video-tags" ng-show="allowedTags && allowedTags.length > 0">
					<div class="col-xs-12 text-left">
						<tags-input ng-model="review.tags" placeholder="Add at least one tag" add-from-autocomplete-only="true" spellcheck="false" ng-required="allowedTags && allowedTags.length > 0" class="form-group" replace-spaces-with-dashes="false">
							<auto-complete source="autocompleteTag($query.toLowerCase())" min-length="1" load-on-empty="true" load-on-focus="true" max-results-to-show="20"></auto-complete>
						</tags-input>
						<a href="/r/meta/561f7880e4b0e41639be51d0" target="_blank">Do you miss a tag?</a>
					</div>
				</div>
		  		<div class="row">
					<div class="col-sm-2">
			  			<button type="submit" class="btn btn-primary btn-upload" ng-click="useVideo ? initUpload() : initPostText()" ng-disabled="uploadInProgress || hasUnsupportedFormatError"  analytics-on="click" analytics-category="upload" analytics-event="upload.request">{{useVideo ? 'Upload' : 'Post'}} now</button>
		  			</div>
				</div>
			</div>


			<div ng-show="uploadInProgress" class="progress-group">
				<div class="informationMessages">
					<span ng-show="uploadProgress  < 100">Your video is being uploaded to our servers. Please don't close the window or you'll have to start all over again :(</span>
					<span ng-show="uploadProgress  == 100">Finalizing your video. Depending on its size, it may take up to 5 minutes. Take some time to think about how you can help others get better too :)</span>
				</div>
			    <div class="progress" style="position: relative; left: 0; top: 0">
			        <div class="progress-bar" role="progressbar" ng-style="{ 'width': uploadProgress  + '%' }" style="position: relative; top: 0; left: 0; min-width: 2em;">
			        	<div>{{uploadProgress  | number : 1}}%</div>
			        </div>
			    </div>
			</div>

		</div>

		<div id="padder"></div>
		<div id="bottom"></div>
	</div>
</form>

<canvas-control show-canvas="showCanvas" hide-canvas="hideCanvas" player-controls="playerControls" review="review" load-canvas="loadCanvas" serialize-canvas="serializeCanvas" clear-canvas="clearCanvas" canvas-state="canvasState" clear-temporary-canvas="clearTemporaryCanvas" prepare-canvas-for-upload="prepareCanvasForUpload" toggle-canvas="toggleCanvas" cancel-canvas-edition="cancelCanvasEdition"></canvas-control>